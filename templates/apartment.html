{% extends "layout.html" %}

{% block content %}
<div class="apartment-detail">
    <div class="container">
        <!-- Кнопка "Назад" -->
        <a href="{{ url_for('apartments') }}" class="btn btn-secondary mb-4">
            &larr; Назад к списку
        </a>

        <div class="apartment-gallery">
            <!-- Основное фото -->
            <div class="main-photo">
                {% if photos %}
                    <img id="main-photo" src="/static/uploads/{{ photos[0].image_url }}" alt="{{ apartment.title }}"
                         onerror="this.src='/static/images/default-apartment.jpg'">
                {% else %}
                    <img id="main-photo" src="/static/images/default-apartment.jpg" alt="{{ apartment.title }}">
                {% endif %}
            </div>

            <!-- Галерея миниатюр -->
            <div class="thumbnails">
                {% if photos %}
                    {% for photo in photos %}
                    <div class="thumbnail" onclick="changeMainPhoto('{{ photo.image_url }}')">
                        <img src="/static/uploads/{{ photo.image_url }}" alt="Фото {{ loop.index }}">
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="thumbnail" onclick="changeMainPhoto('default-apartment.jpg')">
                        <img src="/static/images/default-apartment.jpg" alt="Нет фото">
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="apartment-info">
            <h1>{{ apartment.title }}</h1>
            <p class="location">{{ apartment.district }} район, {{ apartment.address }}</p>

            <div class="price-section">
                <div class="price">{{ "{:,}".format(apartment.price|int) }} ₽/мес</div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#contactModal">
                    Связаться с владельцем
                </button>
            </div>

            <div class="details-grid">
                <div class="detail-item">
                    <i class="fas fa-bed"></i>
                    <span>{{ apartment.rooms }} комн.</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-layer-group"></i>
                    <span>{{ apartment.floor }} этаж</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-expand"></i>
                    <span>{{ apartment.area }} м²</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-user"></i>
                    <span>{{ apartment.username }}</span>
                </div>
            </div>

            <div class="description">
                <h3>Описание</h3>
                <p>{{ apartment.description or 'Нет описания' }}</p>
            </div>

            {% if apartment.owner_id == session.get('id') %}
            <div class="owner-actions mt-4">
                <a href="{{ url_for('edit_apartment', apartment_id=apartment.id) }}" class="btn btn-warning me-2">
                    Редактировать
                </a>
                <form action="{{ url_for('delete_apartment', apartment_id=apartment.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Удалить это объявление?')">
                        Удалить
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для связи -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactModalLabel">Связаться с владельцем</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if session.get('loggedin') %}
                    <form id="contactForm" action="{{ url_for('send_contact_request') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="apartment_id" value="{{ apartment.id }}">

                        <div class="mb-3">
                            <label class="form-label">Ваше сообщение</label>
                            <textarea class="form-control" name="message" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ваш телефон</label>
                            <input type="tel" class="form-control" name="phone"
                                   value="{{ session.get('phone', '') }}" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Отправить</button>
                    </form>
                {% else %}
                    <p>Для связи с владельцем необходимо <a href="{{ url_for('login') }}">войти в систему</a>.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function changeMainPhoto(photoUrl) {
    document.getElementById('main-photo').src = '/static/uploads/' + photoUrl;
}
</script>

<style>
.apartment-gallery {
    margin-bottom: 30px;
}
.main-photo img {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
}
.thumbnails {
    display: flex;
    gap: 10px;
}
.thumbnail img {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
}
.thumbnail img:hover {
    opacity: 0.8;
}
.price-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 20px 0;
}
.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin: 20px 0;
}
.detail-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
}
</style>
{% endblock %}